<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project_1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #202225;
        }
        .transition-all { transition: all 0.2s ease-in-out; }
        .transition-opacity { transition: opacity 0.2s ease-in-out; }
        .transition-transform { transition: transform 0.2s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .item-fade-in { animation: fadeIn 0.3s ease-in-out forwards; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-gray-300 antialiased">

    <div id="app-container" class="flex flex-col h-screen">
        <!-- Header -->
        <header class="flex items-center justify-between p-4 w-full flex-shrink-0">
            <div class="flex items-center space-x-4">
                 <button id="back-button" class="p-2 rounded-full hover:bg-gray-700 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h1 id="header-title" class="text-xl font-bold text-white">project_1</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button class="p-2 rounded-full hover:bg-gray-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg></button>
                <button class="p-2 rounded-full hover:bg-gray-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></button>
            </div>
        </header>

        <!-- Grid View -->
        <main id="grid-view" class="flex-grow p-8 overflow-y-auto no-scrollbar">
            <div id="item-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-8"></div>
        </main>

        <!-- Album Detail View -->
        <main id="album-view" class="hidden flex-grow p-8 overflow-y-auto no-scrollbar">
            <div class="flex flex-col md:flex-row gap-8">
                <!-- Left Side: Album Art & Info -->
                <div class="w-full md:w-1/3 lg:w-1/4 flex-shrink-0">
                    <img id="album-view-cover" src="" class="w-full h-auto object-cover rounded-lg shadow-2xl mb-4">
                    <h2 id="album-view-title" class="text-3xl font-bold text-white"></h2>
                    <p id="album-view-artist" class="text-lg text-gray-400"></p>
                    <p id="album-view-meta" class="text-sm text-gray-500 mt-1"></p>
                    <button id="album-play-button" class="mt-4 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-full flex items-center justify-center text-lg">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M4.018 15.59a.5.5 0 00.816.372l10-6a.5.5 0 000-.744l-10-6A.5.5 0 004.018 4.41v11.18z"></path></svg>
                        Play
                    </button>
                </div>
                <!-- Right Side: Track List -->
                <div id="drop-zone" class="w-full md:w-2/3 lg:w-3/4">
                    <div id="track-list" class="space-y-2">
                        <!-- Tracks will be loaded here -->
                    </div>
                     <div id="drop-message" class="mt-4 text-center p-8 border-2 border-dashed border-gray-700 rounded-lg">
                        <p class="text-gray-500">Drag & Drop Audio Files Here to Add Tracks</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Context Menus & Modals -->
    <div id="context-menu-bg" class="fixed bg-gray-800 text-white w-56 rounded-md shadow-xl py-2 z-50 hidden opacity-0 transform scale-95 transition-all">
        <a href="#" id="add-album-btn" class="flex items-center px-4 py-2 text-sm hover:bg-indigo-600 rounded-md m-1 transition-colors">+ Add Album</a>
        <a href="#" id="add-folder-btn" class="flex items-center px-4 py-2 text-sm hover:bg-indigo-600 rounded-md m-1 transition-colors">+ Add Folder</a>
    </div>
    <div id="context-menu-item" class="fixed bg-gray-800 text-white w-56 rounded-md shadow-xl py-2 z-50 hidden opacity-0 transform scale-95 transition-all">
        <a href="#" id="rename-btn" class="flex items-center px-4 py-2 text-sm hover:bg-indigo-600 rounded-md m-1 transition-colors">Rename</a>
        <a href="#" id="edit-btn" class="flex items-center px-4 py-2 text-sm hover:bg-indigo-600 rounded-md m-1 transition-colors">Edit</a>
        <div class="border-t border-gray-700 my-1"></div>
        <a href="#" id="delete-btn" class="flex items-center px-4 py-2 text-sm text-red-400 hover:bg-red-500 hover:text-white rounded-md m-1 transition-colors">Delete</a>
    </div>
    <div id="rename-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 opacity-0 transition-opacity">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md transform scale-95 transition-transform">
            <h2 class="text-2xl font-bold text-white mb-6">Rename Item</h2>
            <form id="rename-form"><input type="text" id="rename-input" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white"><div class="mt-8 flex justify-end space-x-4"><button type="button" class="modal-cancel py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white rounded-lg">Cancel</button><button type="submit" class="py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg">Save</button></div></form>
        </div>
    </div>
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 opacity-0 transition-opacity">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md transform scale-95 transition-transform">
            <h2 class="text-2xl font-bold text-white mb-6">Edit Album</h2>
            <form id="edit-form"><div class="space-y-4"><div><label class="block text-sm text-gray-400">Album Title</label><input type="text" id="edit-title" required class="mt-1 block w-full bg-gray-700 rounded-md py-2 px-3 text-white"></div><div><label class="block text-sm text-gray-400">Artist Name</label><input type="text" id="edit-artist" required class="mt-1 block w-full bg-gray-700 rounded-md py-2 px-3 text-white"></div><div><label class="block text-sm text-gray-400">Image URL</label><input type="url" id="edit-image-url" required class="mt-1 block w-full bg-gray-700 rounded-md py-2 px-3 text-white"></div></div><div class="mt-8 flex justify-end space-x-4"><button type="button" class="modal-cancel py-2 px-4 bg-gray-600 rounded-lg">Cancel</button><button type="submit" class="py-2 px-4 bg-indigo-600 rounded-lg">Save</button></div></form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- State Management ---
        let currentView = 'grid'; // 'grid' or 'album'
        let currentFolderId = 'root';
        let currentAlbum = null; // { id, data }
        let navigationStack = [{id: 'root', title: 'project_1'}];
        let contextTarget = null;
        let itemCount = 0;
        let tracksUnsubscribe = null;

        // --- DOM Elements ---
        const gridView = document.getElementById('grid-view');
        const albumView = document.getElementById('album-view');
        const itemGrid = document.getElementById('item-grid');
        const headerTitle = document.getElementById('header-title');
        const backButton = document.getElementById('back-button');
        const contextMenuBg = document.getElementById('context-menu-bg');
        const contextMenuItem = document.getElementById('context-menu-item');
        const renameModal = document.getElementById('rename-modal');
        const editModal = document.getElementById('edit-modal');
        const dropZone = document.getElementById('drop-zone');

        // --- Firebase Setup ---
        const firebaseConfig = {
            apiKey: "AIzaSyB4-unm8Z03o3XXgjjlZcIY2tiSskqO2Xc",
            authDomain: "project-1-f9e5b.firebaseapp.com",
            projectId: "project-1-f9e5b",
            storageBucket: "project-1-f9e5b.appspot.com",
            messagingSenderId: "272340259942",
            appId: "1:272340259942:web:a5a5a302342e0b4eb389a7",
            measurementId: "G-EKL8BPFSG1"
        };
        let db, auth, itemsCollection;
        
        async function initializeFirebase() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            itemsCollection = collection(db, `items`);
            await signInAnonymously(auth);
            onAuthStateChanged(auth, user => user && listenForItems());
        }

        // --- Navigation & View Management ---
        function navigateTo(folderId, folderTitle) {
            navigationStack.push({id: folderId, title: folderTitle});
            currentFolderId = folderId;
            updateView('grid');
        }

        function navigateBack() {
            if (currentView === 'album' || navigationStack.length > 1) {
                history.back();
            }
        }
        
        function showAlbumView(album) {
            currentAlbum = album;
            const albumUrl = `/album/${encodeURIComponent(album.data.title.replace(/\s+/g, '-'))}`;
            history.pushState({ view: 'album', albumId: album.id, folderId: currentFolderId }, album.data.title, albumUrl);
            updateView('album');
        }

        function updateView(view) {
            currentView = view;
            if (tracksUnsubscribe) tracksUnsubscribe(); // Stop listening to old track lists

            if (view === 'grid') {
                const currentFolder = navigationStack[navigationStack.length - 1];
                headerTitle.textContent = currentFolder.title;
                backButton.style.display = navigationStack.length > 1 ? 'block' : 'none';
                gridView.classList.remove('hidden');
                albumView.classList.add('hidden');
                listenForItems();
            } else if (view === 'album') {
                headerTitle.textContent = currentAlbum.data.title;
                backButton.classList.remove('hidden');
                gridView.classList.add('hidden');
                albumView.classList.remove('hidden');
                document.getElementById('album-view-cover').src = currentAlbum.data.imageUrl;
                document.getElementById('album-view-title').textContent = currentAlbum.data.title;
                document.getElementById('album-view-artist').textContent = currentAlbum.data.artist;
                listenForTracks(currentAlbum.id);
            }
        }
        
        // --- Data Rendering ---
        function renderItems(docs) {
            itemGrid.innerHTML = '';
            itemCount = docs.length;
            docs.forEach(doc => {
                const item = { id: doc.id, data: doc.data() };
                const el = document.createElement('div');
                el.className = 'w-48 space-y-2 cursor-pointer group item-fade-in';
                el.innerHTML = item.data.type === 'album' ? `
                    <img src="${item.data.imageUrl}" class="w-full h-48 object-cover rounded-lg shadow-lg group-hover:scale-105 transition-transform" onerror="this.src='https://placehold.co/200x200/333/fff?text=Error';">
                    <div class="text-white"><h3 class="font-bold">${item.data.title}</h3><p class="text-sm text-gray-400">${item.data.artist}</p></div>
                ` : `
                    <div class="w-full h-48 rounded-lg shadow-lg bg-gray-700 flex items-center justify-center group-hover:scale-105 transition-transform"><svg class="h-24 w-24 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg></div>
                    <div class="text-white"><h3 class="font-bold">${item.data.title}</h3><p class="text-sm text-gray-400">Folder</p></div>
                `;
                el.addEventListener('click', () => item.data.type === 'folder' ? navigateTo(item.id, item.data.title) : showAlbumView(item));
                el.addEventListener('contextmenu', e => { e.preventDefault(); e.stopPropagation(); contextTarget = item; showContextMenu(contextMenuItem, e.clientX, e.clientY); });
                itemGrid.appendChild(el);
            });
        }

        function renderTracks(docs) {
            const trackList = document.getElementById('track-list');
            trackList.innerHTML = '';
            document.getElementById('album-view-meta').textContent = `${docs.length} tracks`;
            docs.forEach((doc, index) => {
                const track = doc.data();
                const el = document.createElement('div');
                el.className = 'flex items-center p-2 rounded-md hover:bg-gray-700 text-gray-400';
                el.innerHTML = `<div class="w-8 text-right mr-4">${index + 1}</div><div class="flex-grow text-white">${track.fileName}</div>`;
                trackList.appendChild(el);
            });
        }

        // --- Firestore Logic ---
        function listenForItems() {
            const q = query(itemsCollection);
            onSnapshot(q, snapshot => {
                const filtered = snapshot.docs.filter(doc => doc.data().parentId === currentFolderId);
                const sorted = filtered.sort((a, b) => (a.data().createdAt?.toDate() || 0) - (b.data().createdAt?.toDate() || 0));
                renderItems(sorted);
            });
        }

        function listenForTracks(albumId) {
            const tracksCollection = collection(db, `items/${albumId}/tracks`);
            const q = query(tracksCollection);
            tracksUnsubscribe = onSnapshot(q, snapshot => {
                 const sorted = snapshot.docs.sort((a, b) => (a.data().createdAt?.toDate() || 0) - (b.data().createdAt?.toDate() || 0));
                 renderTracks(sorted);
            });
        }

        async function createItem(type) {
            const newItemName = `project_${itemCount + 1}`;
            const newItemData = { title: newItemName, type, parentId: currentFolderId, createdAt: new Date() };
            if (type === 'album') {
                newItemData.artist = 'untitled';
                newItemData.imageUrl = `https://placehold.co/200x200/5865F2/FFFFFF?text=${newItemName.replace('_', '+')}`;
            }
            await addDoc(itemsCollection, newItemData);
        }

        async function addTrack(albumId, file) {
            const tracksCollection = collection(db, `items/${albumId}/tracks`);
            await addDoc(tracksCollection, { fileName: file.name, createdAt: new Date() });
        }

        async function updateItem(id, data) { await updateDoc(doc(db, `items`, id), data); }
        async function deleteItem(id) { await deleteDoc(doc(db, `items`, id)); }

        // --- UI (Menus & Modals) ---
        function showContextMenu(menu, x, y) {
            hideAllContextMenus();
            menu.style.left = `${x}px`; menu.style.top = `${y}px`;
            menu.classList.remove('hidden');
            setTimeout(() => menu.classList.remove('opacity-0', 'scale-95'), 10);
        }
        function hideAllContextMenus() { [contextMenuBg, contextMenuItem].forEach(m => { m.classList.add('opacity-0', 'scale-95'); setTimeout(() => m.classList.add('hidden'), 200); }); }
        function showModal(modal, target) {
            modal.classList.remove('hidden');
            const form = modal.querySelector('form');
            if (modal === renameModal) form.querySelector('#rename-input').value = target.data.title;
            else if (modal === editModal) {
                form.querySelector('#edit-title').value = target.data.title;
                form.querySelector('#edit-artist').value = target.data.artist;
                form.querySelector('#edit-image-url').value = target.data.imageUrl;
            }
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); }, 10);
        }
        function hideAllModals() { [renameModal, editModal].forEach(m => { m.classList.add('opacity-0'); m.querySelector('div').classList.add('scale-95'); setTimeout(() => m.classList.add('hidden'), 200); }); }

        // --- Event Listeners ---
        window.addEventListener('popstate', (event) => {
            if (event.state) {
                if (event.state.view === 'album') {
                    // This logic needs to be improved to re-fetch album data if needed
                    updateView('album');
                } else {
                    navigationStack.pop();
                    currentFolderId = event.state.folderId;
                    updateView('grid');
                }
            } else {
                // Initial state
                navigationStack = [{id: 'root', title: 'project_1'}];
                currentFolderId = 'root';
                updateView('grid');
            }
        });

        document.getElementById('grid-view').addEventListener('contextmenu', e => { e.preventDefault(); e.stopPropagation(); showContextMenu(contextMenuBg, e.clientX, e.clientY); });
        window.addEventListener('click', hideAllContextMenus);
        backButton.addEventListener('click', navigateBack);
        
        // Drag and Drop for tracks
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false));
        ['dragenter', 'dragover'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.add('bg-gray-700'), false));
        ['dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.remove('bg-gray-700'), false));
        dropZone.addEventListener('drop', e => {
            for (const file of e.dataTransfer.files) {
                if (file.type.startsWith('audio/')) {
                    addTrack(currentAlbum.id, file);
                }
            }
        });

        // Menu Buttons
        document.getElementById('add-album-btn').addEventListener('click', e => { e.preventDefault(); createItem('album'); });
        document.getElementById('add-folder-btn').addEventListener('click', e => { e.preventDefault(); createItem('folder'); });
        document.getElementById('rename-btn').addEventListener('click', e => { e.preventDefault(); showModal(renameModal, contextTarget); });
        document.getElementById('edit-btn').addEventListener('click', e => { e.preventDefault(); if(contextTarget.data.type === 'album') showModal(editModal, contextTarget); else alert("Can only edit folders."); });
        document.getElementById('delete-btn').addEventListener('click', e => { e.preventDefault(); if(confirm('Are you sure?')) deleteItem(contextTarget.id); });

        // Modal Forms
        document.getElementById('rename-form').addEventListener('submit', e => { e.preventDefault(); const newTitle = document.getElementById('rename-input').value; if (newTitle) updateItem(contextTarget.id, { title: newTitle }); hideAllModals(); });
        document.getElementById('edit-form').addEventListener('submit', e => { e.preventDefault(); const newData = { title: document.getElementById('edit-title').value, artist: document.getElementById('edit-artist').value, imageUrl: document.getElementById('edit-image-url').value }; if (newData.title && newData.artist && newData.imageUrl) updateItem(contextTarget.id, newData); hideAllModals(); });
        document.querySelectorAll('.modal-cancel').forEach(btn => btn.addEventListener('click', hideAllModals));

        // --- Initialize ---
        initializeFirebase();
        history.replaceState({ view: 'grid', folderId: 'root' }, 'project_1', '/');
        updateView('grid');

    </script>
</body>
</html>
